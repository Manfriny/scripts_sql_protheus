Select
SC503.C5_XPEDREF PEDIDO_REF,
sc501.c5_client as COD_CLIENTE,
sc501.c5_lojacli as LOJA_CLIENTE,
TRIM(sa1.a1_nome) AS NOME,
sa1.a1_cgc as CPF_CNPJ,
CASE 
WHEN SC503.C5_XCANAPV != '' THEN 'CANCELADO'
WHEN (
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL != ' ' )  > 
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' ) 
 AND
 (Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' )  > 0
 ) THEN 'FATURADO PARCIAL' 
WHEN (
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL != ' ' )  > 
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' ) 
 AND
 (Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' )  = 0
 ) THEN 'FATURADO TOTAL' 
ELSE 'SEM FATURAMENTO' END AS STATUS,
SC501.C5_FILIAL  FILIAL_ORIGEM , SC503.C5_FILIAL FILIAL_DESTINO, 
SC501.C5_NUM PV_ORIGEM, SC503.C5_NUM PV_DESTINO,
SUBSTR(SC501.C5_EMISSAO,7,2)||'/'||SUBSTR(SC501.C5_EMISSAO,5,2)||'/'||SUBSTR(SC501.C5_EMISSAO,1,4) PV_EMISSAO_ORIGEM, 
SUBSTR(SC503.C5_EMISSAO,7,2)||'/'||SUBSTR(SC503.C5_EMISSAO,5,2)||'/'||SUBSTR(SC503.C5_EMISSAO,1,4) PV_EMISSAO_DESTINO,
SC501.C5_XVLTOTA   TOTAL_ORIGEM, SC503.C5_XVLTOTA TOTAL_DESTINO , 
SC501.C5_XTOTDES DESCONTO_ORIGEM, SC503.C5_XTOTDES DESCONTO_DESTINO, 
SUBSTR(SC501.C5_DATA1,7,2)||'/'||SUBSTR(SC501.C5_DATA1,5,2)||'/'||SUBSTR(SC501.C5_DATA1,1,4) PRIMEIRO_ORIGEM, 
SUBSTR(SC503.C5_DATA1,7,2)||'/'||SUBSTR(SC503.C5_DATA1,5,2)||'/'||SUBSTR(SC503.C5_DATA1,1,4) PRIMEIRO_DESTINO,
SUBSTR(SC501.C5_DATA2,7,2)||'/'||SUBSTR(SC501.C5_DATA2,5,2)||'/'||SUBSTR(SC501.C5_DATA2,1,4) SEGUNDO_ORIGEM, 
SUBSTR(SC503.C5_DATA2,7,2)||'/'||SUBSTR(SC503.C5_DATA2,5,2)||'/'||SUBSTR(SC503.C5_DATA2,1,4) SEGUNDO_DESTINO,
SUBSTR(SC501.C5_DATA3,7,2)||'/'||SUBSTR(SC501.C5_DATA3,5,2)||'/'||SUBSTR(SC501.C5_DATA3,1,4) TERCEIRO_ORIGEM, 
SUBSTR(SC503.C5_DATA3,7,2)||'/'||SUBSTR(SC503.C5_DATA3,5,2)||'/'||SUBSTR(SC503.C5_DATA3,1,4) TERCEIRO_DESTINO,
SUBSTR(SC501.C5_DATA4,7,2)||'/'||SUBSTR(SC501.C5_DATA4,5,2)||'/'||SUBSTR(SC501.C5_DATA4,1,4) QUARTO_ORIGEM, 
SUBSTR(SC503.C5_DATA4,7,2)||'/'||SUBSTR(SC503.C5_DATA4,5,2)||'/'||SUBSTR(SC503.C5_DATA4,1,4) QUARTO_DESTINO,
SUBSTR(SC501.C5_DATA5,7,2)||'/'||SUBSTR(SC501.C5_DATA5,5,2)||'/'||SUBSTR(SC501.C5_DATA5,1,4) QUINTO_ORIGEM, 
SUBSTR(SC503.C5_DATA5,7,2)||'/'||SUBSTR(SC503.C5_DATA5,5,2)||'/'||SUBSTR(SC503.C5_DATA5,1,4) QUINTO_DESTINO
from  SC5010 SC503
INNER join SC5010 SC501 ON SC501.C5_FILIAL = SUBSTR(SC503.C5_XPEDREF,1,4)  AND  RTRIM(SC501.C5_NUM) = RTRIM(SUBSTR(SC503.C5_XPEDREF,6,LENGTH(SC503.C5_XPEDREF ) ) )
INNER JOIN SA1010 SA1 ON sa1.d_e_l_e_t_=' ' AND sc501.c5_client = sa1.a1_cod AND sc501.c5_lojacli=sa1.a1_loja
WHERE SC503.C5_FILIAL = '0303'
AND SC503.D_E_L_E_T_  = ' '
AND SC503.C5_XPEDREF != ' '
UNION ALL
Select
SC503.C5_XPEDREF PEDIDO_REF,
sc501.c5_client as COD_CLIENTE,
sc501.c5_lojacli as LOJA_CLIENTE,
TRIM(sa1.a1_nome) AS NOME,
sa1.a1_cgc as CPF_CNPJ,
CASE 
WHEN SC503.C5_XCANAPV != '' THEN 'CANCELADO'
WHEN (
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL != ' ' )  > 
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' ) 
 AND
 (Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' )  > 0
 ) THEN 'FATURADO PARCIAL' 
WHEN (
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL != ' ' )  > 
(Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' ) 
 AND
 (Select COUNT(C9_PEDIDO) from SC9010 SC9 Where SC9.d_e_l_e_t_=' ' and C9_FILIAL = SC503.C5_FILIAL AND C9_PEDIDO = SC503.C5_NUM  and C9_NFISCAL = ' ' )  = 0
 ) THEN 'FATURADO TOTAL' 
ELSE 'SEM FATURAMENTO' END AS STATUS,
SC501.C5_FILIAL  FILIAL_ORIGEM , SC503.C5_FILIAL FILIAL_DESTINO, 
SC501.C5_NUM PV_ORIGEM, SC503.C5_NUM PV_DESTINO,
SUBSTR(SC501.C5_EMISSAO,7,2)||'/'||SUBSTR(SC501.C5_EMISSAO,5,2)||'/'||SUBSTR(SC501.C5_EMISSAO,1,4) PV_EMISSAO_ORIGEM, 
SUBSTR(SC503.C5_EMISSAO,7,2)||'/'||SUBSTR(SC503.C5_EMISSAO,5,2)||'/'||SUBSTR(SC503.C5_EMISSAO,1,4) PV_EMISSAO_DESTINO,
SC501.C5_XVLTOTA   TOTAL_ORIGEM, SC503.C5_XVLTOTA TOTAL_DESTINO , 
SC501.C5_XTOTDES DESCONTO_ORIGEM, SC503.C5_XTOTDES DESCONTO_DESTINO, 
SUBSTR(SC501.C5_DATA1,7,2)||'/'||SUBSTR(SC501.C5_DATA1,5,2)||'/'||SUBSTR(SC501.C5_DATA1,1,4) PRIMEIRO_ORIGEM, 
SUBSTR(SC503.C5_DATA1,7,2)||'/'||SUBSTR(SC503.C5_DATA1,5,2)||'/'||SUBSTR(SC503.C5_DATA1,1,4) PRIMEIRO_DESTINO,
SUBSTR(SC501.C5_DATA2,7,2)||'/'||SUBSTR(SC501.C5_DATA2,5,2)||'/'||SUBSTR(SC501.C5_DATA2,1,4) SEGUNDO_ORIGEM, 
SUBSTR(SC503.C5_DATA2,7,2)||'/'||SUBSTR(SC503.C5_DATA2,5,2)||'/'||SUBSTR(SC503.C5_DATA2,1,4) SEGUNDO_DESTINO,
SUBSTR(SC501.C5_DATA3,7,2)||'/'||SUBSTR(SC501.C5_DATA3,5,2)||'/'||SUBSTR(SC501.C5_DATA3,1,4) TERCEIRO_ORIGEM, 
SUBSTR(SC503.C5_DATA3,7,2)||'/'||SUBSTR(SC503.C5_DATA3,5,2)||'/'||SUBSTR(SC503.C5_DATA3,1,4) TERCEIRO_DESTINO,
SUBSTR(SC501.C5_DATA4,7,2)||'/'||SUBSTR(SC501.C5_DATA4,5,2)||'/'||SUBSTR(SC501.C5_DATA4,1,4) QUARTO_ORIGEM, 
SUBSTR(SC503.C5_DATA4,7,2)||'/'||SUBSTR(SC503.C5_DATA4,5,2)||'/'||SUBSTR(SC503.C5_DATA4,1,4) QUARTO_DESTINO,
SUBSTR(SC501.C5_DATA5,7,2)||'/'||SUBSTR(SC501.C5_DATA5,5,2)||'/'||SUBSTR(SC501.C5_DATA5,1,4) QUINTO_ORIGEM, 
SUBSTR(SC503.C5_DATA5,7,2)||'/'||SUBSTR(SC503.C5_DATA5,5,2)||'/'||SUBSTR(SC503.C5_DATA5,1,4) QUINTO_DESTINO
from  SC5010 SC503
INNER join SC5010 SC501 ON SC501.C5_FILIAL = SUBSTR(SC503.C5_XPEDREF,1,4)  AND  RTRIM(SC501.C5_NUM) = RTRIM(SUBSTR(SC503.C5_XPEDREF,6,LENGTH(SC503.C5_XPEDREF ) ) )
INNER JOIN SA1010 SA1 ON sa1.d_e_l_e_t_=' ' AND sc501.c5_client = sa1.a1_cod AND sc501.c5_lojacli=sa1.a1_loja
WHERE SC503.C5_FILIAL = '0301'
AND SC503.D_E_L_E_T_  = ' '
AND SC503.C5_XPEDREF != ' '
